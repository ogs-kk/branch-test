Lots of code added to allow users to log in