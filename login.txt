Lots of code added to allow users to log in.

Login was broken, this fixes it.

Try again